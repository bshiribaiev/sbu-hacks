module.exports=[64528,e=>{"use strict";var t,n,o,i,s,a,r,l,c,d,u,h,p,g,f,m,y,E,v,C,b,O,A,R,I=e.i(47909),w=e.i(74017),N=e.i(96250),_=e.i(59756),S=e.i(61916),T=e.i(14444),x=e.i(37092),M=e.i(69741),$=e.i(16795),L=e.i(87718),P=e.i(95169),G=e.i(47587),D=e.i(66012),F=e.i(70101),j=e.i(26937),U=e.i(10372),k=e.i(93695);e.i(52474);var H=e.i(220),B=e.i(89171);(t=p||(p={})).STRING="string",t.NUMBER="number",t.INTEGER="integer",t.BOOLEAN="boolean",t.ARRAY="array",t.OBJECT="object",(n=g||(g={})).LANGUAGE_UNSPECIFIED="language_unspecified",n.PYTHON="python",(o=f||(f={})).OUTCOME_UNSPECIFIED="outcome_unspecified",o.OUTCOME_OK="outcome_ok",o.OUTCOME_FAILED="outcome_failed",o.OUTCOME_DEADLINE_EXCEEDED="outcome_deadline_exceeded";let K=["user","model","function","system"];(i=m||(m={})).HARM_CATEGORY_UNSPECIFIED="HARM_CATEGORY_UNSPECIFIED",i.HARM_CATEGORY_HATE_SPEECH="HARM_CATEGORY_HATE_SPEECH",i.HARM_CATEGORY_SEXUALLY_EXPLICIT="HARM_CATEGORY_SEXUALLY_EXPLICIT",i.HARM_CATEGORY_HARASSMENT="HARM_CATEGORY_HARASSMENT",i.HARM_CATEGORY_DANGEROUS_CONTENT="HARM_CATEGORY_DANGEROUS_CONTENT",(s=y||(y={})).HARM_BLOCK_THRESHOLD_UNSPECIFIED="HARM_BLOCK_THRESHOLD_UNSPECIFIED",s.BLOCK_LOW_AND_ABOVE="BLOCK_LOW_AND_ABOVE",s.BLOCK_MEDIUM_AND_ABOVE="BLOCK_MEDIUM_AND_ABOVE",s.BLOCK_ONLY_HIGH="BLOCK_ONLY_HIGH",s.BLOCK_NONE="BLOCK_NONE",(a=E||(E={})).HARM_PROBABILITY_UNSPECIFIED="HARM_PROBABILITY_UNSPECIFIED",a.NEGLIGIBLE="NEGLIGIBLE",a.LOW="LOW",a.MEDIUM="MEDIUM",a.HIGH="HIGH",(r=v||(v={})).BLOCKED_REASON_UNSPECIFIED="BLOCKED_REASON_UNSPECIFIED",r.SAFETY="SAFETY",r.OTHER="OTHER",(l=C||(C={})).FINISH_REASON_UNSPECIFIED="FINISH_REASON_UNSPECIFIED",l.STOP="STOP",l.MAX_TOKENS="MAX_TOKENS",l.SAFETY="SAFETY",l.RECITATION="RECITATION",l.LANGUAGE="LANGUAGE",l.OTHER="OTHER",(c=b||(b={})).TASK_TYPE_UNSPECIFIED="TASK_TYPE_UNSPECIFIED",c.RETRIEVAL_QUERY="RETRIEVAL_QUERY",c.RETRIEVAL_DOCUMENT="RETRIEVAL_DOCUMENT",c.SEMANTIC_SIMILARITY="SEMANTIC_SIMILARITY",c.CLASSIFICATION="CLASSIFICATION",c.CLUSTERING="CLUSTERING",(d=O||(O={})).MODE_UNSPECIFIED="MODE_UNSPECIFIED",d.AUTO="AUTO",d.ANY="ANY",d.NONE="NONE",(u=A||(A={})).MODE_UNSPECIFIED="MODE_UNSPECIFIED",u.MODE_DYNAMIC="MODE_DYNAMIC";class q extends Error{constructor(e){super(`[GoogleGenerativeAI Error]: ${e}`)}}class Y extends q{constructor(e,t){super(e),this.response=t}}class V extends q{constructor(e,t,n,o){super(e),this.status=t,this.statusText=n,this.errorDetails=o}}class z extends q{}(h=R||(R={})).GENERATE_CONTENT="generateContent",h.STREAM_GENERATE_CONTENT="streamGenerateContent",h.COUNT_TOKENS="countTokens",h.EMBED_CONTENT="embedContent",h.BATCH_EMBED_CONTENTS="batchEmbedContents";class W{constructor(e,t,n,o,i){this.model=e,this.task=t,this.apiKey=n,this.stream=o,this.requestOptions=i}toString(){var e,t;let n=(null==(e=this.requestOptions)?void 0:e.apiVersion)||"v1beta",o=(null==(t=this.requestOptions)?void 0:t.baseUrl)||"https://generativelanguage.googleapis.com",i=`${o}/${n}/${this.model}:${this.task}`;return this.stream&&(i+="?alt=sse"),i}}async function J(e){var t,n;let o,i=new Headers;i.append("Content-Type","application/json"),i.append("x-goog-api-client",(n=e.requestOptions,o=[],(null==n?void 0:n.apiClient)&&o.push(n.apiClient),o.push("genai-js/0.21.0"),o.join(" "))),i.append("x-goog-api-key",e.apiKey);let s=null==(t=e.requestOptions)?void 0:t.customHeaders;if(s){if(!(s instanceof Headers))try{s=new Headers(s)}catch(e){throw new z(`unable to convert customHeaders value ${JSON.stringify(s)} to Headers: ${e.message}`)}for(let[e,t]of s.entries()){if("x-goog-api-key"===e)throw new z(`Cannot set reserved header name ${e}`);if("x-goog-api-client"===e)throw new z(`Header name ${e} can only be set using the apiClient field`);i.append(e,t)}}return i}async function X(e,t,n,o,i,s){let a=new W(e,t,n,o,s);return{url:a.toString(),fetchOptions:Object.assign(Object.assign({},function(e){let t={};if((null==e?void 0:e.signal)!==void 0||(null==e?void 0:e.timeout)>=0){let n=new AbortController;(null==e?void 0:e.timeout)>=0&&setTimeout(()=>n.abort(),e.timeout),(null==e?void 0:e.signal)&&e.signal.addEventListener("abort",()=>{n.abort()}),t.signal=n.signal}return t}(s)),{method:"POST",headers:await J(a),body:i})}}async function Z(e,t,n,o,i,s={},a=fetch){let{url:r,fetchOptions:l}=await X(e,t,n,o,i,s);return Q(r,l,a)}async function Q(e,t,n=fetch){let o;try{o=await n(e,t)}catch(n){var i=n,s=e;let t=i;throw i instanceof V||i instanceof z||((t=new q(`Error fetching from ${s.toString()}: ${i.message}`)).stack=i.stack),t}return o.ok||await ee(o,e),o}async function ee(e,t){let n,o="";try{let t=await e.json();o=t.error.message,t.error.details&&(o+=` ${JSON.stringify(t.error.details)}`,n=t.error.details)}catch(e){}throw new V(`Error fetching from ${t.toString()}: [${e.status} ${e.statusText}] ${o}`,e.status,e.statusText,n)}function et(e){return e.text=()=>{if(e.candidates&&e.candidates.length>0){if(e.candidates.length>1&&console.warn(`This response had ${e.candidates.length} candidates. Returning text from the first candidate only. Access response.candidates directly to use the other candidates.`),ei(e.candidates[0]))throw new Y(`${es(e)}`,e);return function(e){var t,n,o,i;let s=[];if(null==(n=null==(t=e.candidates)?void 0:t[0].content)?void 0:n.parts)for(let t of null==(i=null==(o=e.candidates)?void 0:o[0].content)?void 0:i.parts)t.text&&s.push(t.text),t.executableCode&&s.push("\n```"+t.executableCode.language+"\n"+t.executableCode.code+"\n```\n"),t.codeExecutionResult&&s.push("\n```\n"+t.codeExecutionResult.output+"\n```\n");return s.length>0?s.join(""):""}(e)}if(e.promptFeedback)throw new Y(`Text not available. ${es(e)}`,e);return""},e.functionCall=()=>{if(e.candidates&&e.candidates.length>0){if(e.candidates.length>1&&console.warn(`This response had ${e.candidates.length} candidates. Returning function calls from the first candidate only. Access response.candidates directly to use the other candidates.`),ei(e.candidates[0]))throw new Y(`${es(e)}`,e);return console.warn("response.functionCall() is deprecated. Use response.functionCalls() instead."),en(e)[0]}if(e.promptFeedback)throw new Y(`Function call not available. ${es(e)}`,e)},e.functionCalls=()=>{if(e.candidates&&e.candidates.length>0){if(e.candidates.length>1&&console.warn(`This response had ${e.candidates.length} candidates. Returning function calls from the first candidate only. Access response.candidates directly to use the other candidates.`),ei(e.candidates[0]))throw new Y(`${es(e)}`,e);return en(e)}if(e.promptFeedback)throw new Y(`Function call not available. ${es(e)}`,e)},e}function en(e){var t,n,o,i;let s=[];if(null==(n=null==(t=e.candidates)?void 0:t[0].content)?void 0:n.parts)for(let t of null==(i=null==(o=e.candidates)?void 0:o[0].content)?void 0:i.parts)t.functionCall&&s.push(t.functionCall);return s.length>0?s:void 0}let eo=[C.RECITATION,C.SAFETY,C.LANGUAGE];function ei(e){return!!e.finishReason&&eo.includes(e.finishReason)}function es(e){var t,n,o;let i="";if((!e.candidates||0===e.candidates.length)&&e.promptFeedback)i+="Response was blocked",(null==(t=e.promptFeedback)?void 0:t.blockReason)&&(i+=` due to ${e.promptFeedback.blockReason}`),(null==(n=e.promptFeedback)?void 0:n.blockReasonMessage)&&(i+=`: ${e.promptFeedback.blockReasonMessage}`);else if(null==(o=e.candidates)?void 0:o[0]){let t=e.candidates[0];ei(t)&&(i+=`Candidate was blocked due to ${t.finishReason}`,t.finishMessage&&(i+=`: ${t.finishMessage}`))}return i}function ea(e){return this instanceof ea?(this.v=e,this):new ea(e)}"function"==typeof SuppressedError&&SuppressedError;let er=/^data\: (.*)(?:\n\n|\r\r|\r\n\r\n)/;async function el(e){let t=[],n=e.getReader();for(;;){let{done:e,value:o}=await n.read();if(e)return et(function(e){let t=e[e.length-1],n={promptFeedback:null==t?void 0:t.promptFeedback};for(let t of e){if(t.candidates)for(let e of t.candidates){let t=e.index;if(n.candidates||(n.candidates=[]),n.candidates[t]||(n.candidates[t]={index:e.index}),n.candidates[t].citationMetadata=e.citationMetadata,n.candidates[t].groundingMetadata=e.groundingMetadata,n.candidates[t].finishReason=e.finishReason,n.candidates[t].finishMessage=e.finishMessage,n.candidates[t].safetyRatings=e.safetyRatings,e.content&&e.content.parts){n.candidates[t].content||(n.candidates[t].content={role:e.content.role||"user",parts:[]});let o={};for(let i of e.content.parts)i.text&&(o.text=i.text),i.functionCall&&(o.functionCall=i.functionCall),i.executableCode&&(o.executableCode=i.executableCode),i.codeExecutionResult&&(o.codeExecutionResult=i.codeExecutionResult),0===Object.keys(o).length&&(o.text=""),n.candidates[t].content.parts.push(o)}}t.usageMetadata&&(n.usageMetadata=t.usageMetadata)}return n}(t));t.push(o)}}async function ec(e,t,n,o){return function(e){let t,[n,o]=(t=e.body.pipeThrough(new TextDecoderStream("utf8",{fatal:!0})).getReader(),new ReadableStream({start(e){let n="";return function o(){return t.read().then(({value:t,done:i})=>{let s;if(i)return n.trim()?void e.error(new q("Failed to parse stream")):void e.close();let a=(n+=t).match(er);for(;a;){try{s=JSON.parse(a[1])}catch(t){e.error(new q(`Error parsing JSON response: "${a[1]}"`));return}e.enqueue(s),a=(n=n.substring(a[0].length)).match(er)}return o()})}()}})).tee();return{stream:function(e){return function(e,t,n){if(!Symbol.asyncIterator)throw TypeError("Symbol.asyncIterator is not defined.");var o,i=n.apply(e,t||[]),s=[];return o={},a("next"),a("throw"),a("return"),o[Symbol.asyncIterator]=function(){return this},o;function a(e){i[e]&&(o[e]=function(t){return new Promise(function(n,o){s.push([e,t,n,o])>1||r(e,t)})})}function r(e,t){try{var n;(n=i[e](t)).value instanceof ea?Promise.resolve(n.value.v).then(l,c):d(s[0][2],n)}catch(e){d(s[0][3],e)}}function l(e){r("next",e)}function c(e){r("throw",e)}function d(e,t){e(t),s.shift(),s.length&&r(s[0][0],s[0][1])}}(this,arguments,function*(){let t=e.getReader();for(;;){let{value:e,done:n}=yield ea(t.read());if(n)break;yield yield ea(et(e))}})}(n),response:el(o)}}(await Z(t,R.STREAM_GENERATE_CONTENT,e,!0,JSON.stringify(n),o))}async function ed(e,t,n,o){let i=await Z(t,R.GENERATE_CONTENT,e,!1,JSON.stringify(n),o);return{response:et(await i.json())}}function eu(e){if(null!=e){if("string"==typeof e)return{role:"system",parts:[{text:e}]};if(e.text)return{role:"system",parts:[e]};if(e.parts)if(!e.role)return{role:"system",parts:e.parts};else return e}}function eh(e){let t=[];if("string"==typeof e)t=[{text:e}];else for(let n of e)"string"==typeof n?t.push({text:n}):t.push(n);var n=t;let o={role:"user",parts:[]},i={role:"function",parts:[]},s=!1,a=!1;for(let e of n)"functionResponse"in e?(i.parts.push(e),a=!0):(o.parts.push(e),s=!0);if(s&&a)throw new q("Within a single message, FunctionResponse cannot be mixed with other type of part in the request for sending chat message.");if(!s&&!a)throw new q("No content is provided for sending chat message.");return s?o:i}function ep(e){let t;return t=e.contents?e:{contents:[eh(e)]},e.systemInstruction&&(t.systemInstruction=eu(e.systemInstruction)),t}let eg=["text","inlineData","functionCall","functionResponse","executableCode","codeExecutionResult"],ef={user:["text","inlineData"],function:["functionResponse"],model:["text","functionCall","executableCode","codeExecutionResult"],system:["text"]},em="SILENT_ERROR";class ey{constructor(e,t,n,o={}){this.model=t,this.params=n,this._requestOptions=o,this._history=[],this._sendPromise=Promise.resolve(),this._apiKey=e,(null==n?void 0:n.history)&&(!function(e){let t=!1;for(let n of e){let{role:e,parts:o}=n;if(!t&&"user"!==e)throw new q(`First content should be with role 'user', got ${e}`);if(!K.includes(e))throw new q(`Each item should include role field. Got ${e} but valid roles are: ${JSON.stringify(K)}`);if(!Array.isArray(o))throw new q("Content should have 'parts' property with an array of Parts");if(0===o.length)throw new q("Each Content should have at least one part");let i={text:0,inlineData:0,functionCall:0,functionResponse:0,fileData:0,executableCode:0,codeExecutionResult:0};for(let e of o)for(let t of eg)t in e&&(i[t]+=1);let s=ef[e];for(let t of eg)if(!s.includes(t)&&i[t]>0)throw new q(`Content with role '${e}' can't contain '${t}' part`);t=!0}}(n.history),this._history=n.history)}async getHistory(){return await this._sendPromise,this._history}async sendMessage(e,t={}){var n,o,i,s,a,r;let l;await this._sendPromise;let c=eh(e),d={safetySettings:null==(n=this.params)?void 0:n.safetySettings,generationConfig:null==(o=this.params)?void 0:o.generationConfig,tools:null==(i=this.params)?void 0:i.tools,toolConfig:null==(s=this.params)?void 0:s.toolConfig,systemInstruction:null==(a=this.params)?void 0:a.systemInstruction,cachedContent:null==(r=this.params)?void 0:r.cachedContent,contents:[...this._history,c]},u=Object.assign(Object.assign({},this._requestOptions),t);return this._sendPromise=this._sendPromise.then(()=>ed(this._apiKey,this.model,d,u)).then(e=>{var t;if(e.response.candidates&&e.response.candidates.length>0){this._history.push(c);let n=Object.assign({parts:[],role:"model"},null==(t=e.response.candidates)?void 0:t[0].content);this._history.push(n)}else{let t=es(e.response);t&&console.warn(`sendMessage() was unsuccessful. ${t}. Inspect response object for details.`)}l=e}),await this._sendPromise,l}async sendMessageStream(e,t={}){var n,o,i,s,a,r;await this._sendPromise;let l=eh(e),c={safetySettings:null==(n=this.params)?void 0:n.safetySettings,generationConfig:null==(o=this.params)?void 0:o.generationConfig,tools:null==(i=this.params)?void 0:i.tools,toolConfig:null==(s=this.params)?void 0:s.toolConfig,systemInstruction:null==(a=this.params)?void 0:a.systemInstruction,cachedContent:null==(r=this.params)?void 0:r.cachedContent,contents:[...this._history,l]},d=Object.assign(Object.assign({},this._requestOptions),t),u=ec(this._apiKey,this.model,c,d);return this._sendPromise=this._sendPromise.then(()=>u).catch(e=>{throw Error(em)}).then(e=>e.response).then(e=>{if(e.candidates&&e.candidates.length>0){this._history.push(l);let t=Object.assign({},e.candidates[0].content);t.role||(t.role="model"),this._history.push(t)}else{let t=es(e);t&&console.warn(`sendMessageStream() was unsuccessful. ${t}. Inspect response object for details.`)}}).catch(e=>{e.message!==em&&console.error(e)}),u}}async function eE(e,t,n,o){return(await Z(t,R.COUNT_TOKENS,e,!1,JSON.stringify(n),o)).json()}async function ev(e,t,n,o){return(await Z(t,R.EMBED_CONTENT,e,!1,JSON.stringify(n),o)).json()}async function eC(e,t,n,o){let i=n.requests.map(e=>Object.assign(Object.assign({},e),{model:t}));return(await Z(t,R.BATCH_EMBED_CONTENTS,e,!1,JSON.stringify({requests:i}),o)).json()}class eb{constructor(e,t,n={}){this.apiKey=e,this._requestOptions=n,t.model.includes("/")?this.model=t.model:this.model=`models/${t.model}`,this.generationConfig=t.generationConfig||{},this.safetySettings=t.safetySettings||[],this.tools=t.tools,this.toolConfig=t.toolConfig,this.systemInstruction=eu(t.systemInstruction),this.cachedContent=t.cachedContent}async generateContent(e,t={}){var n;let o=ep(e),i=Object.assign(Object.assign({},this._requestOptions),t);return ed(this.apiKey,this.model,Object.assign({generationConfig:this.generationConfig,safetySettings:this.safetySettings,tools:this.tools,toolConfig:this.toolConfig,systemInstruction:this.systemInstruction,cachedContent:null==(n=this.cachedContent)?void 0:n.name},o),i)}async generateContentStream(e,t={}){var n;let o=ep(e),i=Object.assign(Object.assign({},this._requestOptions),t);return ec(this.apiKey,this.model,Object.assign({generationConfig:this.generationConfig,safetySettings:this.safetySettings,tools:this.tools,toolConfig:this.toolConfig,systemInstruction:this.systemInstruction,cachedContent:null==(n=this.cachedContent)?void 0:n.name},o),i)}startChat(e){var t;return new ey(this.apiKey,this.model,Object.assign({generationConfig:this.generationConfig,safetySettings:this.safetySettings,tools:this.tools,toolConfig:this.toolConfig,systemInstruction:this.systemInstruction,cachedContent:null==(t=this.cachedContent)?void 0:t.name},e),this._requestOptions)}async countTokens(e,t={}){let n=function(e,t){var n;let o={model:null==t?void 0:t.model,generationConfig:null==t?void 0:t.generationConfig,safetySettings:null==t?void 0:t.safetySettings,tools:null==t?void 0:t.tools,toolConfig:null==t?void 0:t.toolConfig,systemInstruction:null==t?void 0:t.systemInstruction,cachedContent:null==(n=null==t?void 0:t.cachedContent)?void 0:n.name,contents:[]},i=null!=e.generateContentRequest;if(e.contents){if(i)throw new z("CountTokensRequest must have one of contents or generateContentRequest, not both.");o.contents=e.contents}else if(i)o=Object.assign(Object.assign({},o),e.generateContentRequest);else{let t=eh(e);o.contents=[t]}return{generateContentRequest:o}}(e,{model:this.model,generationConfig:this.generationConfig,safetySettings:this.safetySettings,tools:this.tools,toolConfig:this.toolConfig,systemInstruction:this.systemInstruction,cachedContent:this.cachedContent}),o=Object.assign(Object.assign({},this._requestOptions),t);return eE(this.apiKey,this.model,n,o)}async embedContent(e,t={}){let n="string"==typeof e||Array.isArray(e)?{content:eh(e)}:e,o=Object.assign(Object.assign({},this._requestOptions),t);return ev(this.apiKey,this.model,n,o)}async batchEmbedContents(e,t={}){let n=Object.assign(Object.assign({},this._requestOptions),t);return eC(this.apiKey,this.model,e,n)}}class eO{constructor(e){this.apiKey=e}getGenerativeModel(e,t){if(!e.model)throw new q("Must provide a model name. Example: genai.getGenerativeModel({ model: 'my-model-name' })");return new eb(this.apiKey,e,t)}getGenerativeModelFromCachedContent(e,t,n){if(!e.name)throw new z("Cached content must contain a `name` field.");if(!e.model)throw new z("Cached content must contain a `model` field.");for(let n of["model","systemInstruction"])if((null==t?void 0:t[n])&&e[n]&&(null==t?void 0:t[n])!==e[n]){if("model"===n&&(t.model.startsWith("models/")?t.model.replace("models/",""):t.model)===(e.model.startsWith("models/")?e.model.replace("models/",""):e.model))continue;throw new z(`Different value for "${n}" specified in modelParams (${t[n]}) and cachedContent (${e[n]})`)}let o=Object.assign(Object.assign({},t),{model:e.model,tools:e.tools,toolConfig:e.toolConfig,systemInstruction:e.systemInstruction,cachedContent:e});return new eb(this.apiKey,o,n)}}var eA=e.i(22734),eR=e.i(14747);async function eI(e){try{var t,n;let o,i,s,a,r,l,c,d,u,{sceneName:h,sceneDescription:p,modelUrl:g,screenshot:f}=await e.json(),m=process.env.GEMINI_API_KEY,y=m&&"your_api_key_here"!==m&&m.length>10;console.log("Analyzing scene:",{sceneName:h,sceneDescription:p.substring(0,100),hasScreenshot:!!f,hasApiKey:!!m,apiKeyLength:m?.length||0,isValidApiKey:y});let E=[],v="mock";if(f&&y){console.log("ðŸŽ¯ Attempting Gemini Vision analysis from screenshot...");try{let e=await eN(f,h,p,m);if(e&&e.length>0)return E=e,v="gemini-vision",console.log(`âœ… Using Gemini Vision: ${E.length} evidence points from visual analysis`),B.NextResponse.json({evidence:E,source:v})}catch(e){console.error("âŒ Gemini Vision error:",e)}}if(g){console.log("ðŸŽ¯ Attempting GLB evidence extraction...");let e=await eT(g);if(e.length>0)return E=e,v="glb",console.log(`âœ… Using GLB data: ${E.length} evidence points extracted`),B.NextResponse.json({evidence:E,source:v});console.log("âš ï¸ No evidence extracted from GLB, trying Gemini text...")}if(y){console.log("Attempting Gemini analysis..."),console.log("API Key format check:",{startsWithAIza:m?.startsWith("AIza"),length:m?.length,firstChars:m?.substring(0,10)});try{let e=await ew(h,p,m,g);if(e&&e.length>0)return E=e,v="gemini",console.log("âœ… Using Gemini results:",E.length,"points"),B.NextResponse.json({evidence:E,source:v});console.log("âš ï¸ Gemini returned empty array, falling back to mock")}catch(e){console.error("âŒ Gemini API error:",e?.message||e),console.error("Full error:",e),e?.message?.includes("404")&&(console.error("ðŸ’¡ TIP: Your API key might not have access to gemini-pro."),console.error("   Try getting a new API key from: https://makersuite.google.com/app/apikey"),console.error("   Or check if your API key has the right permissions."))}}else console.log("â„¹ï¸ No valid Gemini API key found, using mock data"),console.log("   To use Gemini: Add GEMINI_API_KEY to .env.local"),console.log("   Get your key from: https://makersuite.google.com/app/apikey");return console.log("Using mock evidence generation"),t=h,n=p,o=[],i=t.toLowerCase(),s=n.toLowerCase(),console.log("Generating evidence for scene:",t,"lowercase:",i),console.log("Description analysis:",s.substring(0,100)),a=s.includes("body")||s.includes("victim")||s.includes("person"),r=s.includes("struggle")||s.includes("fight")||s.includes("disturbance"),l=s.includes("blood")||s.includes("stain"),c=s.includes("weapon")||s.includes("knife")||s.includes("gun"),d=s.includes("furniture")||s.includes("sofa")||s.includes("chair")||s.includes("bed"),(i.includes("room")||i.includes("bathroom"))&&(console.log("Matched room/bathroom condition"),a&&(o.push({id:"body-1",label:"Victim Position",description:"The body's location and orientation are critical for understanding the sequence of events. Document exact position relative to room features.",position:[0,0,0],category:"evidence",confidence:.95}),o.push({id:"body-2",label:"Immediate Surroundings",description:"Area immediately around the victim may contain trace evidence, fibers, or other materials transferred during the incident.",position:[.3,.1,.3],category:"evidence",confidence:.88})),r&&o.push({id:"struggle-1",label:"Disturbance Area",description:"Signs of struggle or movement detected. Furniture displacement and object scattering indicate potential altercation.",position:[-.8,.5,.5],category:"anomaly",confidence:.85}),l&&o.push({id:"blood-1",label:"Blood Evidence Location",description:"Bloodstain pattern analysis required. Location and distribution may indicate sequence of events.",position:[.5,.05,-.5],category:"evidence",confidence:.92}),c&&o.push({id:"weapon-1",label:"Weapon Location",description:"Weapon positioning relative to victim and other evidence may indicate sequence of events or staging.",position:[.7,.1,.2],category:"evidence",confidence:.9}),d&&o.push({id:"furniture-1",label:"Furniture Arrangement",description:"Furniture positioning inconsistent with normal room layout may indicate struggle, movement, or staging.",position:[-1.2,.5,1.1],category:"furniture",confidence:.85}),0===o.length&&o.push({id:"general-1",label:"Primary Evidence Area",description:"Central area of the scene requiring comprehensive examination and documentation.",position:[0,.3,0],category:"evidence",confidence:.8},{id:"general-2",label:"Entry/Exit Point Analysis",description:"Examine access points for evidence of forced entry, disturbance, or staging.",position:[1.5,.2,-1.2],category:"evidence",confidence:.75},{id:"general-3",label:"Secondary Evidence Zone",description:"Peripheral area may contain trace evidence, footprints, or displaced items.",position:[-1.1,.1,1],category:"evidence",confidence:.7})),i.includes("body")&&(console.log("Matched body condition"),o.push({id:"4",label:"Body Position",description:"Victim positioning and orientation",position:[0,0,0],category:"evidence",confidence:.95},{id:"5",label:"Surrounding Area",description:"Immediate area around body requires analysis",position:[.5,.1,.5],category:"evidence",confidence:.8})),i.includes("bag")&&(console.log("Matched bag condition"),o.push({id:"6",label:"Evidence Bag",description:"Collected evidence items",position:[0,.5,0],category:"object",confidence:.9})),i.includes("chair")&&(console.log("Matched chair condition"),o.push({id:"7",label:"Chair Position",description:"Furniture placement and orientation",position:[0,0,0],category:"furniture",confidence:.85})),i.includes("mattress")&&(console.log("Matched mattress condition"),o.push({id:"8",label:"Bedding Evidence",description:"Mattress condition and positioning",position:[0,.2,0],category:"evidence",confidence:.8})),0===o.length&&(console.log("No specific matches, adding default evidence points"),o.push({id:"default-1",label:"Scene Analysis Required",description:"General scene examination needed",position:[0,.5,0],category:"evidence",confidence:.7},{id:"default-2",label:"Area of Interest",description:"Location requiring detailed investigation",position:[.5,.2,-.5],category:"evidence",confidence:.65})),console.log("Generated",o.length,"base evidence points"),u=o.map(e=>({...e,position:[e.position[0]+(Math.random()-.5)*.3,e.position[1]+(Math.random()-.5)*.2,e.position[2]+(Math.random()-.5)*.3]})),console.log("Final evidence points:",u.length),E=u,console.log("Generated mock evidence:",E.length,"points"),B.NextResponse.json({evidence:E,source:"mock"})}catch(e){return console.error("Error analyzing evidence:",e),B.NextResponse.json({error:"Failed to analyze evidence"},{status:500})}}async function ew(e,t,n,o){try{let i,s=new eO(n);try{i=s.getGenerativeModel({model:"gemini-2.5-flash"}),console.log("Using Gemini model: gemini-1.5-flash")}catch(e){i=s.getGenerativeModel({model:"gemini-pro"}),console.log("Using Gemini model: gemini-pro")}let a="";if(o)try{a=await e_(o)}catch(e){console.log("Could not extract GLB metadata:",e)}let r=`You are analyzing a 3D scene reconstruction for investigation purposes.

SCENE INFORMATION:
Scene Name: "${e}"
Description: "${t}"
${a?`
3D MODEL STRUCTURE:
${a}`:""}

TASK: Identify 5-8 important points of interest in this scene based on the description and objects present.

For each point, provide:
- label: A clear name (e.g., "Key Object Location", "Area of Interest", "Furniture Position")
- description: Why this location is significant (2 sentences)
- position: 3D coordinates [x, y, z] where x=left/right, y=height, z=back/front (use values between -3 and 3)
- category: One of "evidence", "anomaly", "object", or "furniture"
- confidence: A number between 0.6 and 0.95

Return ONLY a valid JSON array in this format:
[
  {
    "label": "Example Point",
    "description": "This area shows important details relevant to the scene investigation.",
    "position": [0.5, 0.5, -0.8],
    "category": "evidence",
    "confidence": 0.85
  }
]

Analyze scene: "${e}"
Description: "${t}"
${a?`
Objects in scene:
${a.split("\n").slice(0,10).join("\n")}`:""}

Return only the JSON array, no other text.`;console.log("Calling Gemini API with prompt length:",r.length),console.log("Model metadata extracted:",a?"Yes":"No");let l=await i.generateContent(r),c=await l.response,d=c.text();if(console.log("Gemini response received, length:",d.length),console.log("Gemini response preview:",d.substring(0,200)),!d||0===d.length){console.warn("âš ï¸ Gemini returned empty response - may be blocked by safety filters"),console.log("Response candidates:",c.candidates),console.log("Finish reason:",c.candidates?.[0]?.finishReason);let e=c.candidates?.[0]?.finishReason;if("SAFETY"===e||"RECITATION"===e)throw console.error("ðŸš« Response blocked by safety filters - try adjusting prompt"),Error("Response blocked by safety filters");throw Error("Empty response from Gemini")}try{let e=d.replace(/```json\n?/g,"").replace(/```\n?/g,"").trim(),t=e.indexOf("["),n=e.lastIndexOf("]");-1!==t&&-1!==n&&n>t&&(e=e.substring(t,n+1)),console.log("Cleaned text for parsing:",e.substring(0,300)),console.log("Full cleaned text length:",e.length);let o=JSON.parse(e);if(Array.isArray(o))return o.map((e,t)=>({id:`gemini-${t+1}`,label:e.label||"Unknown",description:e.description||"",position:Array.isArray(e.position)&&3===e.position.length?e.position:[0,0,0],category:["object","anomaly","evidence","furniture"].includes(e.category)?e.category:"evidence",confidence:"number"==typeof e.confidence?Math.max(0,Math.min(1,e.confidence)):.7}))}catch(e){console.error("Failed to parse Gemini response:",e),console.error("Raw response:",d)}return[]}catch(e){throw console.error("Gemini API error:",e),e}}async function eN(e,t,n,o){try{console.log("ðŸ” Gemini Vision: Analyzing screenshot...");let i=new eO(o).getGenerativeModel({model:"gemini-1.5-pro"}),s=e.replace(/^data:image\/\w+;base64,/,""),a=`You are analyzing a 3D crime scene reconstruction IMAGE.

SCENE: ${t}
DESCRIPTION: ${n}

Look carefully at this 3D scene and identify ALL visible evidence items, objects, and points of interest.

For EACH item you can see, estimate its 3D position where:
- X axis: left (-3) to right (+3), with 0 in the center
- Y axis: floor (0) to ceiling (3)
- Z axis: back of room (-3) to front (3)

Return a JSON array of 6-10 items you can actually SEE in the image:

[
  {
    "label": "Item Name",
    "description": "What makes this forensically significant (2 sentences max)",
    "position": [x, y, z],
    "category": "evidence" or "furniture" or "object" or "anomaly",
    "confidence": 0.6-0.95
  }
]

IMPORTANT:
- Only identify items you can ACTUALLY SEE in the image
- Use realistic position estimates based on where they appear visually
- Bodies, weapons, blood = "evidence"
- Chairs, tables, beds = "furniture"
- Entry/exit points = "anomaly"
- Other items = "object"

Return ONLY the JSON array, no markdown, no explanations.`;console.log("Sending screenshot to Gemini Vision (size:",s.length,"chars)");let r=await i.generateContent([a,{inlineData:{data:s,mimeType:"image/png"}}]),l=(await r.response).text();if(console.log("Vision response received, length:",l.length),console.log("Vision response preview:",l.substring(0,200)),!l||0===l.length)return console.warn("âš ï¸ Gemini Vision returned empty response"),[];try{let e=l.replace(/```json\n?/g,"").replace(/```\n?/g,"").trim(),t=e.indexOf("["),n=e.lastIndexOf("]");-1!==t&&-1!==n&&n>t&&(e=e.substring(t,n+1));let o=JSON.parse(e);if(Array.isArray(o)){let e=o.map((e,t)=>({id:`vision-${t+1}`,label:e.label||"Unknown",description:e.description||"",position:Array.isArray(e.position)&&3===e.position.length?e.position:[0,0,0],category:["object","anomaly","evidence","furniture"].includes(e.category)?e.category:"object",confidence:"number"==typeof e.confidence?Math.max(0,Math.min(1,e.confidence)):.75}));return console.log(`âœ… Parsed ${e.length} evidence points from Vision AI`),e.forEach((e,t)=>{console.log(`  Vision Point ${t}: ${e.label} at [${e.position.map(e=>e.toFixed(2)).join(", ")}]`)}),e}}catch(e){console.error("Failed to parse Vision response:",e),console.error("Raw response:",l)}return[]}catch(e){throw console.error("Gemini Vision API error:",e),e}}async function e_(e){try{let t=e.replace("/models/",""),n=eR.default.join(process.cwd(),"public","models",t);if(!eA.default.existsSync(n))return"Model file not found";let o=eA.default.statSync(n),i=eR.default.basename(n),s=i.replace(".glb","").replace(/-/g," "),a=eA.default.readFileSync(n);if(a.length<12)return`Invalid GLB file: ${i}`;let r=a.readUInt32LE(0),l=a.readUInt32LE(4);if(a.readUInt32LE(8),0x46546c67!==r)return`Not a valid GLB file: ${i}`;if(a.length<20)return`GLB file too small: ${i}`;let c=a.readUInt32LE(12),d=a.readUInt32LE(16);if(0x4e4f534a!==d)return`Invalid GLB structure: ${i}`;let u=a.slice(20,20+c),h=JSON.parse(u.toString("utf8")),p=h.nodes||[],g=h.meshes||[],f=h.materials||[],m=[];return p.forEach((e,t)=>{let n=e.name||`Node_${t}`,o=e.translation||[0,0,0],i=e.mesh;if(void 0!==i&&g[i]){let e=g[i].name||`Mesh_${i}`;m.push(`${n} (${e}) at position [${o[0]?.toFixed(2)||0}, ${o[1]?.toFixed(2)||0}, ${o[2]?.toFixed(2)||0}]`)}else m.push(`${n} at position [${o[0]?.toFixed(2)||0}, ${o[1]?.toFixed(2)||0}, ${o[2]?.toFixed(2)||0}]`)}),`3D MODEL METADATA:
Scene: ${s}
File: ${i}
Size: ${(o.size/1024/1024).toFixed(2)} MB
Format: GLB v${l}

OBJECTS IN SCENE:
${m.length>0?m.slice(0,20).join("\n"):"No named objects found"}
${m.length>20?`
... and ${m.length-20} more objects`:""}

Total Nodes: ${p.length}
Total Meshes: ${g.length}
Total Materials: ${f.length}`}catch(t){try{let n=e.replace("/models/",""),o=eR.default.join(process.cwd(),"public","models",n),i=eA.default.statSync(o),s=eR.default.basename(o);return`3D Model: ${s.replace(".glb","")}
File: ${s}
Size: ${(i.size/1024/1024).toFixed(2)} MB
Note: Could not parse GLB structure - ${t}`}catch{return"Error reading model metadata"}}}function eS(e){return e.replace(/([A-Z])/g," $1").replace(/[-_]/g," ").split(" ").map(e=>e.charAt(0).toUpperCase()+e.slice(1).toLowerCase()).join(" ").trim()}async function eT(e){try{let t=e.replace("/models/",""),n=eR.default.join(process.cwd(),"public","models",t);if(!eA.default.existsSync(n))return console.log("GLB file not found for evidence extraction"),[];let o=eR.default.basename(n,".glb"),i=eR.default.dirname(n);if(("room"===o||"bathroom"===o||"dark-room"===o)&&eA.default.existsSync(i)){console.log(`ðŸ” Scanning folder for individual evidence items: ${i}`);let e=[];try{let t=eA.default.readdirSync(i).filter(e=>e.endsWith(".glb")&&e!==`${o}.glb`&&!e.startsWith("dark-"));for(let n of(console.log(`Found ${t.length} individual evidence files`),t)){let t=eR.default.join(i,n),o=await ex(t);o.length>0&&e.push(...o)}if(e.length>0)return console.log(`âœ… Extracted ${e.length} evidence points from folder scan`),e}catch(e){console.error("Error scanning folder:",e)}}return await ex(n)}catch(e){return console.error("Error extracting evidence from GLB:",e),console.error("Stack:",e instanceof Error?e.stack:e),[]}}async function ex(e){try{let t=eA.default.readFileSync(e);if(t.length<20)return[];let n=t.readUInt32LE(0);if(0x46546c67!==n)return[];let o=t.readUInt32LE(12),i=t.readUInt32LE(16);if(0x4e4f534a!==i)return[];let s=t.slice(20,20+o),a=JSON.parse(s.toString("utf8")),r=a.nodes||[],l=a.meshes||[],c=a.accessors||[],d=[],u=eR.default.basename(e,".glb");return eS(u),r.forEach((e,t)=>{let n,o;if(void 0===e.mesh||!l[e.mesh])return;let i=e.name||`Object_${t}`,s=i.toLowerCase();(i.startsWith("Object_")||i.startsWith("Node_")||s.startsWith("geometry")||i.startsWith("Mesh_")||"Scene"===i||"Root"===i||/^(Object|Node|Mesh|Geometry)\s*\d+$/i.test(i))&&u&&"room"!==u&&"scene"!==u&&(i=u),n=e.translation&&3===e.translation.length?[Number(e.translation[0])||0,Number(e.translation[1])||0,Number(e.translation[2])||0]:(e=>{try{let t=l[e];if(!t?.primitives?.[0])return[0,0,0];let n=t.primitives[0].attributes?.POSITION;if(void 0===n)return[0,0,0];let o=c[n];if(!o?.min||!o?.max)return[0,0,0];return[(o.min[0]+o.max[0])/2,(o.min[1]+o.max[1])/2,(o.min[2]+o.max[2])/2]}catch(e){return[0,0,0]}})(e.mesh);let a=(o=i.toLowerCase()).includes("body")||o.includes("blood")||o.includes("weapon")||o.includes("knife")||o.includes("gun")?"evidence":o.includes("chair")||o.includes("table")||o.includes("bed")||o.includes("mattress")||o.includes("furniture")?"furniture":o.includes("door")||o.includes("window")||o.includes("entrance")?"anomaly":"object",r=eS(i),h="";h="evidence"===a?"Critical evidence detected in scene. This item requires detailed forensic examination and documentation.":"furniture"===a?"Furniture item that may contain trace evidence or provide spatial context for the investigation.":"anomaly"===a?"Potential point of entry/exit or area of interest requiring further investigation.":"Physical object present in scene. Position and state may be relevant to investigation timeline.",d.push({id:`glb-${t}`,label:r,description:h,position:n,category:a,confidence:.95})}),console.log(`âœ… Extracted ${d.length} evidence points from single GLB`),d.forEach((e,t)=>{console.log(`  Point ${t}: ${e.label} at [${e.position.map(e=>e.toFixed(2)).join(", ")}]`)}),d}catch(e){return console.error("Error extracting from single GLB:",e),[]}}e.s(["POST",()=>eI],97278);var eM=e.i(97278);let e$=new I.AppRouteRouteModule({definition:{kind:w.RouteKind.APP_ROUTE,page:"/api/analyze-evidence/route",pathname:"/api/analyze-evidence",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/app/api/analyze-evidence/route.ts",nextConfigOutput:"",userland:eM}),{workAsyncStorage:eL,workUnitAsyncStorage:eP,serverHooks:eG}=e$;function eD(){return(0,N.patchFetch)({workAsyncStorage:eL,workUnitAsyncStorage:eP})}async function eF(e,t,n){e$.isDev&&(0,_.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let o="/api/analyze-evidence/route";o=o.replace(/\/index$/,"")||"/";let i=await e$.prepare(e,t,{srcPage:o,multiZoneDraftMode:!1});if(!i)return t.statusCode=400,t.end("Bad Request"),null==n.waitUntil||n.waitUntil.call(n,Promise.resolve()),null;let{buildId:s,params:a,nextConfig:r,parsedUrl:l,isDraftMode:c,prerenderManifest:d,routerServerContext:u,isOnDemandRevalidate:h,revalidateOnlyGenerated:p,resolvedPathname:g,clientReferenceManifest:f,serverActionsManifest:m}=i,y=(0,M.normalizeAppPath)(o),E=!!(d.dynamicRoutes[y]||d.routes[g]),v=async()=>((null==u?void 0:u.render404)?await u.render404(e,t,l,!1):t.end("This page could not be found"),null);if(E&&!c){let e=!!d.routes[g],t=d.dynamicRoutes[y];if(t&&!1===t.fallback&&!e){if(r.experimental.adapterPath)return await v();throw new k.NoFallbackError}}let C=null;!E||e$.isDev||c||(C="/index"===(C=g)?"/":C);let b=!0===e$.isDev||!E,O=E&&!b;m&&f&&(0,T.setReferenceManifestsSingleton)({page:o,clientReferenceManifest:f,serverActionsManifest:m,serverModuleMap:(0,x.createServerModuleMap)({serverActionsManifest:m})});let A=e.method||"GET",R=(0,S.getTracer)(),I=R.getActiveScopeSpan(),N={params:a,prerenderManifest:d,renderOpts:{experimental:{authInterrupts:!!r.experimental.authInterrupts},cacheComponents:!!r.cacheComponents,supportsDynamicResponse:b,incrementalCache:(0,_.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:r.cacheLife,waitUntil:n.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,n,o)=>e$.onRequestError(e,t,o,u)},sharedContext:{buildId:s}},B=new $.NodeNextRequest(e),K=new $.NodeNextResponse(t),q=L.NextRequestAdapter.fromNodeNextRequest(B,(0,L.signalFromNodeResponse)(t));try{let i=async e=>e$.handle(q,N).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let n=R.getRootSpanAttributes();if(!n)return;if(n.get("next.span_type")!==P.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${n.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let i=n.get("next.route");if(i){let t=`${A} ${i}`;e.setAttributes({"next.route":i,"http.route":i,"next.span_name":t}),e.updateName(t)}else e.updateName(`${A} ${o}`)}),s=!!(0,_.getRequestMeta)(e,"minimalMode"),a=async a=>{var l,g;let f=async({previousCacheEntry:r})=>{try{if(!s&&h&&p&&!r)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let o=await i(a);e.fetchMetrics=N.renderOpts.fetchMetrics;let l=N.renderOpts.pendingWaitUntil;l&&n.waitUntil&&(n.waitUntil(l),l=void 0);let c=N.renderOpts.collectedTags;if(!E)return await (0,D.sendResponse)(B,K,o,N.renderOpts.pendingWaitUntil),null;{let e=await o.blob(),t=(0,F.toNodeOutgoingHttpHeaders)(o.headers);c&&(t[U.NEXT_CACHE_TAGS_HEADER]=c),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let n=void 0!==N.renderOpts.collectedRevalidate&&!(N.renderOpts.collectedRevalidate>=U.INFINITE_CACHE)&&N.renderOpts.collectedRevalidate,i=void 0===N.renderOpts.collectedExpire||N.renderOpts.collectedExpire>=U.INFINITE_CACHE?void 0:N.renderOpts.collectedExpire;return{value:{kind:H.CachedRouteKind.APP_ROUTE,status:o.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:n,expire:i}}}}catch(t){throw(null==r?void 0:r.isStale)&&await e$.onRequestError(e,t,{routerKind:"App Router",routePath:o,routeType:"route",revalidateReason:(0,G.getRevalidateReason)({isStaticGeneration:O,isOnDemandRevalidate:h})},u),t}},m=await e$.handleResponse({req:e,nextConfig:r,cacheKey:C,routeKind:w.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:d,isRoutePPREnabled:!1,isOnDemandRevalidate:h,revalidateOnlyGenerated:p,responseGenerator:f,waitUntil:n.waitUntil,isMinimalMode:s});if(!E)return null;if((null==m||null==(l=m.value)?void 0:l.kind)!==H.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==m||null==(g=m.value)?void 0:g.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});s||t.setHeader("x-nextjs-cache",h?"REVALIDATED":m.isMiss?"MISS":m.isStale?"STALE":"HIT"),c&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let y=(0,F.fromNodeOutgoingHttpHeaders)(m.value.headers);return s&&E||y.delete(U.NEXT_CACHE_TAGS_HEADER),!m.cacheControl||t.getHeader("Cache-Control")||y.get("Cache-Control")||y.set("Cache-Control",(0,j.getCacheControlHeader)(m.cacheControl)),await (0,D.sendResponse)(B,K,new Response(m.value.body,{headers:y,status:m.value.status||200})),null};I?await a(I):await R.withPropagatedContext(e.headers,()=>R.trace(P.BaseServerSpan.handleRequest,{spanName:`${A} ${o}`,kind:S.SpanKind.SERVER,attributes:{"http.method":A,"http.target":e.url}},a))}catch(t){if(t instanceof k.NoFallbackError||await e$.onRequestError(e,t,{routerKind:"App Router",routePath:y,routeType:"route",revalidateReason:(0,G.getRevalidateReason)({isStaticGeneration:O,isOnDemandRevalidate:h})}),E)throw t;return await (0,D.sendResponse)(B,K,new Response(null,{status:500})),null}}e.s(["handler",()=>eF,"patchFetch",()=>eD,"routeModule",()=>e$,"serverHooks",()=>eG,"workAsyncStorage",()=>eL,"workUnitAsyncStorage",()=>eP],64528)}];

//# sourceMappingURL=node_modules_next_dist_esm_build_templates_app-route_3ec7f083.js.map